#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#include <sys/socket.h>      // 소켓 관련 함수 선언
#include <arpa/inet.h>       // IP 주소 변환 함수 사용
#include <netinet/ip.h>      // IP 헤더 구조체 정의 포함
#include <linux/if_packet.h> // RAW 소켓과 이더넷 헤더 정의
#include <net/ethernet.h>    // 이더넷 프로토콜 상수 포함

// IP 헤더 출력 함수
void print_ip_header(unsigned char *buffer) {
    struct iphdr *iph = (struct iphdr*)(buffer + sizeof(struct ethhdr)); // 이더넷 헤더 크기만큼 건너뜀
    struct sockaddr_in src, dst;

    src.sin_addr.s_addr = iph->saddr; // 출발지 주소
    dst.sin_addr.s_addr = iph->daddr; // 목적지 주소

    // IP 주소와 프로토콜 번호 출력
    printf("========== IP 헤더 정보 ==========\n");
    printf("출발지 IP: %s\n", inet_ntoa(src.sin_addr));
    printf("목적지 IP: %s\n", inet_ntoa(dst.sin_addr));
    printf("프로토콜 번호: %u\n\n", (unsigned int)iph->protocol);
}

int main() {
    // raw socket 생성: 모든 프로토콜 패킷 수신
    int sockfd = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));
    if (sockfd < 0) {
        perror("소켓 생성 실패");
        return 1;
    }

    unsigned char buffer[65536]; // 패킷 수신 버퍼

    // 패킷 수신 루
    while (1) {
        int size = recvfrom(sockfd, buffer, sizeof(buffer), 0, NULL, NULL);
        if (size < 0) {
            perror("수신 실패");
            break;
        }

        print_ip_header(buffer); // IP 헤더 출력

        printf("=================================\n");
        
    }

    close(sockfd); // 소켓 닫기
    return 0;
}

